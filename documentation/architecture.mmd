%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#4A90E2','primaryTextColor':'#fff','primaryBorderColor':'#2E5C8A','lineColor':'#6c757d','secondaryColor':'#50C878','tertiaryColor':'#F5A623','noteBkgColor':'#FFF8DC','noteTextColor':'#333','fontSize':'14px'}}}%%

graph TB
    subgraph frontend["<b>Frontend Layer</b><br/><i>Next.js + React + TypeScript</i>"]
        UI[ğŸ–¥ï¸ Chat UI]
        VR[ğŸ™ï¸ Voice Recorder]
        SP[âš™ï¸ Settings Panel]
        WS[ğŸ”Œ WebSocket Client]
    end

    subgraph backend["<b>Backend API Layer</b><br/><i>FastAPI + Python</i>"]
        REST[ğŸ“¡ REST Endpoints]
        WSH[ğŸ”„ WebSocket Handler]
        TS[ğŸ¤ Transcription Service<br/><small>Whisper Local</small>]
        SM[ğŸ‘¥ Session Manager]
    end

    subgraph rag["<b>RAG Pipeline - Core Intelligence</b><br/><i>Hybrid Retrieval + Reranking</i>"]
        QE[ğŸ” Query Enhancer]
        HR[ğŸ”€ Hybrid Retrieval]
        RR[ğŸ¯ Cross-Encoder Reranker]
        CF[ğŸ“‹ Context Formatter]
        MM[ğŸ§  Memory Manager]
        
        subgraph retrieval["Hybrid Search"]
            VS[ğŸ“Š Vector Search<br/><small>Semantic</small>]
            BM[ğŸ“ BM25 Search<br/><small>Keyword</small>]
            FUSION[âš¡ RRF Fusion]
        end
    end

    subgraph storage["<b>Data Storage Layer</b><br/><i>Vector + Keyword Indices</i>"]
        CHROMA[(ğŸ—„ï¸ ChromaDB<br/>Vector Store<br/><small>384-dim embeddings</small>)]
        BM25[(ğŸ“š BM25 Index<br/>Keyword Search)]
    end

    subgraph llm["<b>Language Model</b><br/><i>Local LLM Inference</i>"]
        OLLAMA[ğŸ¤– Ollama<br/>Llama 3.1 8B<br/><small>100% Local</small>]
    end

    subgraph ingestion["<b>Data Ingestion Pipeline</b><br/><i>Offline Processing</i>"]
        PDF[ğŸ“„ PDF Documents] --> CHUNK[âœ‚ï¸ Chunking<br/><small>Recursive</small>]
        CHUNK --> EMB[ğŸ”¢ Embedding Service<br/><small>Sentence Transformers</small>]
        EMB --> INGEST1[ğŸ’¾ Vector Store<br/>Ingestion]
        EMB --> INGEST2[ğŸ“‡ BM25 Index<br/>Building]
    end

    %% Frontend to Backend
    UI -.->|HTTP/WS| REST
    VR -.->|Audio| REST
    WS -.->|Stream| WSH
    SP -.->|Config| REST

    %% Backend to RAG
    REST ==>|Query| QE
    WSH ==>|Query| QE
    TS -.->|Transcribed Text| QE

    %% RAG Pipeline Flow
    QE ==>|Enhanced Query| HR
    HR ==> VS
    HR ==> BM
    VS --> FUSION
    BM --> FUSION
    FUSION ==>|Candidates| RR
    RR ==>|Top Results| CF
    CF ==>|Formatted Context| MM

    %% RAG to Storage
    VS <-.->|Semantic Search| CHROMA
    BM <-.->|Keyword Search| BM25

    %% RAG to LLM
    MM ==>|Context + History| OLLAMA
    OLLAMA ==>|Generated Response| WSH

    %% Response back
    WSH -.->|Streaming| WS
    WSH -.->|Response| REST

    %% Ingestion to Storage
    INGEST1 -.->|Store Vectors| CHROMA
    INGEST2 -.->|Build Index| BM25

    %% Styling
    classDef frontendClass fill:#E3F2FD,stroke:#4A90E2,stroke-width:3px,color:#000
    classDef backendClass fill:#E8F5E9,stroke:#50C878,stroke-width:3px,color:#000
    classDef ragClass fill:#FFF3E0,stroke:#F5A623,stroke-width:3px,color:#000
    classDef storageClass fill:#F3E5F5,stroke:#9C27B0,stroke-width:3px,color:#000
    classDef llmClass fill:#FFEBEE,stroke:#E74C3C,stroke-width:3px,color:#000
    classDef ingestionClass fill:#ECEFF1,stroke:#607D8B,stroke-width:2px,color:#000

    class UI,VR,SP,WS frontendClass
    class REST,WSH,TS,SM backendClass
    class QE,HR,RR,CF,MM,VS,BM,FUSION ragClass
    class CHROMA,BM25 storageClass
    class OLLAMA llmClass
    class PDF,CHUNK,EMB,INGEST1,INGEST2 ingestionClass







