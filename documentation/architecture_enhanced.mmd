%%{init: {'theme':'base', 'themeVariables': {'fontSize':'16px'}}}%%

flowchart TB
    subgraph Frontend["ğŸ’» FRONTEND LAYER - Next.js + React"]
        direction LR
        UI["ğŸ–¥ï¸ Chat UI<br/><small>Text Interface</small>"]
        Voice["ğŸ™ï¸ Voice Recorder<br/><small>Audio Capture</small>"]
        Settings["âš™ï¸ Settings<br/><small>Config Panel</small>"]
        WS["ğŸ”Œ WebSocket<br/><small>Real-time</small>"]
    end

    subgraph Backend["âš¡ BACKEND API - FastAPI"]
        direction LR
        REST["ğŸ“¡ REST API<br/><small>HTTP Endpoints</small>"]
        WSHandler["ğŸ”„ WebSocket Handler<br/><small>Streaming</small>"]
        Transcribe["ğŸ¤ Whisper STT<br/><small>Local Speech-to-Text</small>"]
        SessionMgr["ğŸ‘¥ Session Manager<br/><small>User Sessions</small>"]
    end

    subgraph RAG["ğŸ§  RAG PIPELINE - Core Intelligence"]
        direction TB
        
        subgraph Processing["Query Processing"]
            Enhance["ğŸ” Query Enhancer<br/><small>Context Expansion</small>"]
            Search["ğŸ”€ Hybrid Retrieval<br/><small>Vector + Keyword</small>"]
        end
        
        subgraph Ranking["Result Ranking"]
            Rerank["ğŸ¯ Cross-Encoder<br/><small>ms-marco-MiniLM</small>"]
            Format["ğŸ“‹ Context Formatter<br/><small>With Citations</small>"]
        end
        
        Memory["ğŸ§  Memory Manager<br/><small>Last 5 Turns</small>"]
    end

    subgraph SearchLayer["ğŸ” SEARCH COMPONENTS"]
        direction LR
        VectorSearch["ğŸ“Š Vector Search<br/><small>Semantic Similarity</small>"]
        BM25Search["ğŸ“ BM25 Search<br/><small>Keyword Matching</small>"]
        Fusion["âš¡ RRF Fusion<br/><small>Combine Results</small>"]
    end

    subgraph Storage["ğŸ’¾ DATA STORAGE LAYER"]
        direction LR
        ChromaDB[("ğŸ—„ï¸ ChromaDB<br/><small>Vector Store<br/>384-dim</small>")]
        BM25Index[("ğŸ“š BM25 Index<br/><small>Keyword Index</small>")]
    end

    subgraph LLM["ğŸ¤– LANGUAGE MODEL"]
        Ollama["ğŸ¦™ Ollama<br/><small>Llama 3.1 8B<br/>100% Local</small>"]
    end

    subgraph Ingestion["ğŸ“¥ DATA INGESTION (Offline)"]
        direction LR
        PDFs["ğŸ“„ PDFs"] --> Chunk["âœ‚ï¸ Chunking"]
        Chunk --> Embed["ğŸ”¢ Embeddings"]
        Embed --> IngestV["ğŸ’¾ Vector Store"]
        Embed --> IngestB["ğŸ“‡ BM25 Build"]
    end

    %% Connections
    Frontend ==>|"HTTP/WS"| Backend
    Backend ==>|"Query"| Processing
    
    Enhance --> Search
    Search --> VectorSearch
    Search --> BM25Search
    VectorSearch --> Fusion
    BM25Search --> Fusion
    Fusion --> Rerank
    
    VectorSearch <-.->|"Search"| ChromaDB
    BM25Search <-.->|"Search"| BM25Index
    
    Rerank --> Format
    Format --> Memory
    Memory ==>|"Context"| Ollama
    
    Ollama ==>|"Response"| Backend
    Backend ==>|"Stream"| Frontend
    
    IngestV -.->|"Populate"| ChromaDB
    IngestB -.->|"Build"| BM25Index

    %% Styling
    classDef frontendStyle fill:#E3F2FD,stroke:#1976D2,stroke-width:3px,color:#000
    classDef backendStyle fill:#E8F5E9,stroke:#388E3C,stroke-width:3px,color:#000
    classDef ragStyle fill:#FFF3E0,stroke:#F57C00,stroke-width:3px,color:#000
    classDef searchStyle fill:#FFF9C4,stroke:#F9A825,stroke-width:2px,color:#000
    classDef storageStyle fill:#F3E5F5,stroke:#7B1FA2,stroke-width:3px,color:#000
    classDef llmStyle fill:#FFEBEE,stroke:#C62828,stroke-width:3px,color:#000
    classDef ingestionStyle fill:#ECEFF1,stroke:#546E7A,stroke-width:2px,color:#000

    class Frontend,UI,Voice,Settings,WS frontendStyle
    class Backend,REST,WSHandler,Transcribe,SessionMgr backendStyle
    class RAG,Processing,Ranking,Enhance,Search,Rerank,Format,Memory ragStyle
    class SearchLayer,VectorSearch,BM25Search,Fusion searchStyle
    class Storage,ChromaDB,BM25Index storageStyle
    class LLM,Ollama llmStyle
    class Ingestion,PDFs,Chunk,Embed,IngestV,IngestB ingestionStyle







